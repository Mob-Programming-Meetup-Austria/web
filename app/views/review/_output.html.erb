<script type="text/javascript"><!--
'use strict';
$(() => {

  const review = cd.review;

  cd.plog = (n,o) => console.log(`${n}:${JSON.stringify(o)}`);

  review.refreshOutput = () => {
    const args = { id:review.params.id, index:review.params.nowIndex };
    $.getJSON('/model/kata_event', args, (data) => {
      const event = data.kata_event;
      const stdout = event.stdout.content;
      const stderr = event.stderr.content;
      const status = event.status;
      //cd.plog('stdout', stdout);
      const $stdout = review.makeDiffFileContent(makeSameDiff('stdout', stdout));
      const $stderr = review.makeDiffFileContent(makeSameDiff('stderr', stderr));
      const $status = review.makeDiffFileContent(makeSameDiff('status', status));
      //cd.plog('$stdout', $stdout);
      const $diffContentOuput = $('#diff-content-output');
      $diffContentOuput.append($stdout);
      $diffContentOuput.append($stderr);
      $diffContentOuput.append($status);

      const $diffOutputFilenames = $('#diff-output-filenames');
      $diffOutputFilenames.html(makeDiffOutputFilenames(stdout,stderr,status));

      $('#stdout').click(() => review.selectFile('stdout'));
      $('#stderr').click(() => review.selectFile('stderr'));
      $('#status').click(() => review.selectFile('status'));
    });
  };

  //- - - - - - - - - - - - - - - - - - - - - - - - -
  const makeSameDiff = (filename, str) => {
    const r = {
                  id: filename,
                type: 'unchanged',
            filename: filename,
               lines: makeSameLines(str)
    };
    //if (filename==='stdout') { cd.plog(`makeSameDiff(${filename},${str})`, r); }
    return r;
  };

  //- - - - - - - - - - - - - - - - - - - - - - - - -
  const makeSameLines = (str) => {
    let n = 0;
    const r = lines(str).map(line => {
      return { type:'same', line:line, number:n += 1 };
    });
    return r;
  };
  const lines = (str) => str.replace(/\n$/, '').split(/\r?\n/);

  //- - - - - - - - - - - - - - - - - - - - - - - - -
  const makeDiffOutputFilenames = (stdout,stderr,status) => {
    let html = '';
    html += '<table class="sss filenames">';
    html += `<tr><td class="diff-filename" id="stdout">stdout</td></tr>`;
    html += `<tr><td class="diff-filename" id="stderr">stderr</td></tr>`;
    html += `<tr><td class="diff-filename" id="status">status</td></tr>`;
    html += '</table>';
    return html;
  };

});

//--></script>

<div id="diff-output-filenames"></div>
