<script type="text/javascript"><!--
'use strict';
$(() => {

  const review = cd.review;

  review.refreshOutput = () => {
    const args = { id:review.params.id, index:review.params.nowIndex };
    $.getJSON('/model/kata_event', args, (data) => {
      const event = data.kata_event;
      const stdout = event.stdout.content;
      const stderr = event.stderr.content;
      const status = event.status;

      const diffContent = $('#diff-content');
      const $stdout = review.makeDiffFileContent('stdout', makeLineNumbers(makeSameLines(stdout)), sameLines(stdout));
      const $stderr = review.makeDiffFileContent('stderr', makeLineNumbers(makeSameLines(stderr)), sameLines(stderr));
      const $status = review.makeDiffFileContent('status', [], sameLines(status));

      diffContent.append($stdout);
      diffContent.append($stderr);
      diffContent.append($status);

      const diffOutputFilenames = $('#diff-output-filenames');
      diffOutputFilenames.html(makeDiffOutputFilenames(stdout,stderr,status));

      $('#stdout').click(() => review.selectFile('stdout'));
      $('#stderr').click(() => review.selectFile('stderr'));
      $('#status').click(() => review.selectFile('status'));
    });
  };

  const makeDiffOutputFilenames = (stdout,stderr,status) => {
    let html = '';
    html += '<table class="sss filenames">';
    html += `<tr><td class="diff-filename" id="stdout">stdout</td></tr>`;
    html += `<tr><td class="diff-filename" id="stderr">stderr</td></tr>`;
    html += `<tr><td class="diff-filename" id="status">status</td></tr>`;
    html += '</table>';
    return html;
  };

  //- - - - - - - - - - - - - - - - - - - - - - - - -
  const sameLines = (str) => {
    return lines(cd.htmlEscape(str)).map(line => `<same>${line}</same>`);
  };

  //- - - - - - - - - - - - - - - - - - - - - - - - -
  const makeSameLines = (str) => {
    let n = 0;
    return lines(str).map(line => {
      return { type:'same', line:line, number:n += 1 };
    });
  };
  const lines = (str) => str.replace(/\n$/, '').split(/\r?\n/);

  const makeLineNumbers = (lines) => {
    let numbers = [];
    lines.forEach(line => {
      if (line.type != 'section') {
        numbers.push(`<${line.type}><ln>${line.number}</ln></${line.type}>`);
      }
    });
    return numbers;
  };

});

//--></script>

<div id="diff-output-filenames"></div>
