<script type="text/javascript"><!--
'use strict';
$(() => {

  const review = cd.review;

  review.refreshOutput = () => {
    const args = { id:review.params.id, index:review.params.nowIndex };
    $.getJSON('/model/kata_event', args, (data) => {
      const event = data.kata_event;
      const stdout = event.stdout.content;
      const stderr = event.stderr.content;
      const status = event.status;

      const diffContent = $('#diff-content');
      const $stdout = review.makeDiffFileContent('stdout', sameLineNumbers(stdout), sameLines(stdout));
      const $stderr = review.makeDiffFileContent('stderr', sameLineNumbers(stderr), sameLines(stderr));
      const $status = review.makeDiffFileContent('status', '', sameLines(status));

      diffContent.append($stdout);
      diffContent.append($stderr);
      diffContent.append($status);

      const diffOutputFilenames = $('#diff-output-filenames');
      diffOutputFilenames.html(makeDiffOutputFilenames(stdout,stderr,status));

      $('#stdout').click(() => review.selectFile('stdout'));
      $('#stderr').click(() => review.selectFile('stderr'));
      $('#status').click(() => review.selectFile('status'));
    });
  };

  const makeDiffOutputFilenames = (stdout,stderr,status) => {
    let html = '';
    html += '<table class="sss filenames">';
    html += `<tr><td class="diff-filename" id="stdout">stdout</td></tr>`;
    html += `<tr><td class="diff-filename" id="stderr">stderr</td></tr>`;
    html += `<tr><td class="diff-filename" id="status">status</td></tr>`;
    html += '</table>';
    return html;
  };

  const sameLines = (str) => {
    return lines(htmlEscape(str)).map(line => `<same>${line}</same>`);
  };

  const sameLineNumbers = (str) => {
    if (str === '') {
      return '';
    } else {
      let number = 0;
      return lines(str).map(_line => `<same><ln>${number += 1}</ln></same>`);
    }
  };

  const htmlEscape = (str) => {
    const div = document.createElement('div');
    const text = document.createTextNode(str);
    div.appendChild(text);
    return div.innerHTML;
  };

  const lines = (str) => {
    return str.replace(/\n$/, '')
              .split(/\r?\n/);
  };

});

//--></script>

<div id="diff-output-filenames"></div>
