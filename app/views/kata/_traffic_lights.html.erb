<script type="text/javascript"><!--
'use strict';
$(() => {

  const version = '<%= @version %>';
  const avatarName = '<%= @avatar_name %>';
  const avatarIndex = '<%= @avatar_index %>';
  const groupId = '<%= @group_id %>';

  // - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  // There are two sequences of traffic-lights:
  // o) kata-page traffic-lights live under #traffic-lights.
  //    Click any of these two open the diff-review
  // o) review-page traffic-lights live under #review-traffic-lights.
  //    Click any of these to move to it in the diff-review.
  // - - - - - - - - - - - - - - - - - - - - - - - - - - - -

  // - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  // cd.setupTrafficLights() sets up the tip/click handlers
  // for the kata-page (but not review-page) traffic-lights.
  // It is called in two places:
  //   1) From this file
  //      - This happens when a page loads.
  //      - It sets up the *existing* traffic-lights.
  //   2) From run_tests.js.erb
  //      - This happens when you run the [test]s
  //      - It sets up the *new* traffic-light.
  // - - - - - - - - - - - - - - - - - - - - - - - - - - - -

  const inputIndex = $("input[name='index']"); // the index of most-recent
                                               // (rightmost) traffic-light.
  cd.setupTrafficLights = ($lights) => {
    let wasIndex = inputIndex.val(); // [1]
    $lights.each((_i,element) => {
      const $light = $(element);
      const id = $light.data('id');
      const avatarIndex = $light.data('avatar-index');
      const now = $light.data('index');
      const was = wasIndex; // Avoid lambda capture
      $light.click(() => cd.setReviewData(version, id, groupId, avatarName, avatarIndex, was, now));
      cd.setupTrafficLightTip($light, version, id, avatarIndex, was, now);
      wasIndex = now;
    });
    inputIndex.val(wasIndex);
  };

  const allLights = $('.diff-traffic-light', '#traffic-lights');
  inputIndex.val(0); // [1] Ensure wasIndex == 0 on page *refresh*.
  cd.setupTrafficLights(allLights);

});
//--></script>

<input type="hidden"
       name="index"
       value="">

<div id="traffic-lights">
  <% @lights.each do |light| %>
    <%= raw diff_traffic_light(light, @avatar_index) %>
  <% end %>
</div>
