<script type="text/javascript"><!--
'use strict';
$(() => {

  const version = '<%= @version %>';
  const id = '<%= @id %>';
  const groupId = '<%= @group_id %>';
  const avatarName = '<%= @avatar_name %>';
  const avatarIndex = '<%= @avatar_index %>';

  // - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  const wasIndex = (value) => {
    const inputIndex = $("input[name='index']");
    if (value === undefined) {
      return inputIndex.val();
    } else {
      inputIndex.val(value);
    }
  };

  // - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  // There are two sequences of traffic-lights:
  // o) kata-page traffic-lights live under #traffic-lights.
  //    Click any of these to open the diff-review
  // o) review-page traffic-lights live under #review-traffic-lights.
  //    Click any of these to move to it in the diff-review.
  // - - - - - - - - - - - - - - - - - - - - - - - - - - - -

  // - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  // cd.appendTrafficLight() sets up the tip/click handlers
  // for the kata-page (but not review-page) traffic-lights.
  // It is called in two places:
  //   1) From this file
  //      - This happens when a page loads.
  //      - It sets up the existing traffic-lights.
  //   2) From run_tests.js.erb
  //      - This happens when you run the [test]s
  //      - It sets up the new traffic-light.
  // - - - - - - - - - - - - - - - - - - - - - - - - - - - -

  const $lights = $('#traffic-lights');

  cd.appendTrafficLight = (event) => {
    const colour = event.colour;
    if (colour) {
      const $div = $('<div>', {
        'class':'diff-traffic-light',
        'data-id':id,
        'data-index':event.index,
        'data-avatar-index':avatarIndex,
        'data-colour':colour
      });
      const predicted = event.predicted || 'none';
      const imgSuffix = isRag(colour) ? `_predicted_${predicted}` : '';
      const $img = $('<img>', {
        'src':`/traffic-light/image/${colour}${imgSuffix}.png`,
        'alt':`${colour} traffic-light`
      });
      const $light = $div.append($img);
      $lights.append($light);
      $light.click(() => cd.setReviewData(version, id, groupId, avatarName, avatarIndex, wasIndex(), event.index));
      cd.setupTrafficLightTip($light, version, id, avatarIndex, wasIndex(), event.index);
      updateCounts(event);
    }
    wasIndex(event.index);
  };

  // - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  const counts = {
    red:0,
    amber:0,
    green:0,
    timed_out:0,
    hit:0,
    miss:0,
  };

  const updateCounts = (event) => {
    const colour = event.colour;
    const predicted = event.predicted;
    counts[colour] += 1;
    counts.lastColour = colour;
    if (predicted && predicted != 'none') {
      if (colour === predicted) {
        counts.hit += 1;
      } else {
        counts.miss += 1;
      }
    }
  };

  cd.updateTrafficLightsCount = () => {
    const total = counts.red + counts.amber + counts.green + counts.timed_out;
    if (total > 0) {
      const box = $('#traffic-lights-count-box');
      const $newCount = $('<div>', {
        'class': `traffic-light-count ${counts.lastColour}`,
        'data-tip': 'traffic_light_count',
        'data-red-count': counts.red,
        'data-amber-count': counts.amber,
        'data-green-count': counts.green,
        'data-timed-out-count': counts.timed_out
      }).text(total);
      box.fadeOut('slow', () => {
        box.empty().append($newCount);
        cd.setupHoverTips($('.traffic-light-count'));
        box.fadeIn('slow');
      });
    }
  };

  const isRag = (s) => ['red','amber','green'].includes(s);

  //- - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

  const events = <%= raw @events_json.gsub("\n",'') %>;
  events.forEach((event) => cd.appendTrafficLight(event));
  cd.updateTrafficLightsCount();
  cd.scrollLastTrafficLightIntoView(); // TODO: sometimes misses last few on refresh

});
//--></script>

<!-- The index of most-recent (rightmost) traffic-light -->
<!-- event is updated in the browser and sent back to the -->
<!-- web service as an optimization (so the web service -->
<!-- does not need to retrieve it from saver). -->

<input type="hidden" name="index" value="0">

<div id="traffic-lights"></div>
