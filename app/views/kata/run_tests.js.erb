'use strict';

const appendTestTrafficLight = () => {
  const div = $("<%= raw diff_traffic_light(@kata.id, @colour, @tag) %>");
  const td = $('<td>');
  td.append(div);
  $('.traffic-lights-count').parent().before(td);
  cd.setupReviewTrafficLight(div);
  cd.setupHoverTip(div);
};

//- - - - - - - - - - - - - - - - - - - - - -

const updateOutput = () => {
  cd.deleteFile('output');
  cd.newFile('output', "<%= j(raw(@stdout)) + j(raw(@stderr)) %>");
};

//- - - - - - - - - - - - - - - - - - - - - -

const updateTag = () => {
  cd.setTag("<%= @tag %>");
};

//- - - - - - - - - - - - - - - - - - - - - -

const updateTrafficLightCount = () => {
  $('.traffic-lights-count').html("<%= js_partial('traffic_lights_count') %>");
};


const updateTrafficLightPieChart = () => {
  $('#traffic-lights-pie-chart').html("<%= js_partial('traffic_lights_pie_chart') %>");
};

//- - - - - - - - - - - - - - - - - - - - - -

const addNewFiles = () => {
  <% @new_files.each do |filename,content| %>
    cd.newFile("<%= j raw(filename) %>", "<%= j raw(content) %>");
  <% end %>
};

//- - - - - - - - - - - - - - - - - - - - - -

const removeDeletedFiles = () => {
  <% @deleted_files.keys.each do |filename| %>
    cd.deleteFile("<%= j raw(filename) %>");
  <% end %>
};

//- - - - - - - - - - - - - - - - - - - - - -

const updateChangedFiles = () => {
  <% @changed_files.each do |filename,content| %>
    cd.deleteFile("<%= j raw(filename) %>");
    cd.newFile("<%= j raw(filename) %>", "<%= j raw(content) %>");
  <% end %>
};

//- - - - - - - - - - - - - - - - - - - - - -

appendTestTrafficLight();
updateOutput();
updateTag();
updateTrafficLightCount();
updateTrafficLightPieChart();

addNewFiles();
removeDeletedFiles();
updateChangedFiles();

cd.storeIncomingFileHashes();
cd.scrollAvatarImageIntoView();
